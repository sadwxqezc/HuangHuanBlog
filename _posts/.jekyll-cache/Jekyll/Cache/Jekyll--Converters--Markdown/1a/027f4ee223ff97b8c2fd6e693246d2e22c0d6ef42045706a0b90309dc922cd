I"½<ul id="markdown-toc">
  <li><a href="#èƒŒæ™¯" id="markdown-toc-èƒŒæ™¯">èƒŒæ™¯</a></li>
  <li><a href="#åŸå› åˆ†æ" id="markdown-toc-åŸå› åˆ†æ">åŸå› åˆ†æ</a>    <ul>
      <li><a href="#æ•°æ®è¡¨å’Œä¾‹å­" id="markdown-toc-æ•°æ®è¡¨å’Œä¾‹å­">æ•°æ®è¡¨å’Œä¾‹å­</a></li>
      <li><a href="#åŸå› åˆ†æ-1" id="markdown-toc-åŸå› åˆ†æ-1">åŸå› åˆ†æ</a></li>
    </ul>
  </li>
</ul>
<h2 id="èƒŒæ™¯">èƒŒæ™¯</h2>

<p>å‚è€ƒé“¾æ¥ï¼š<a href="https://bugs.mysql.com/bug.php?id=52020">InnoDB can still deadlock on just INSERTâ€¦ON DUPLICATE KEY</a></p>

<p>åœ¨å¯¹ä¸åŒçš„è®°å½•è¿›è¡Œ<code class="language-plaintext highlighter-rouge">INSERT...ON DUPLICATE KEY</code>æ“ä½œæ—¶ï¼Œç†è®ºä¸Šæ˜¯ä¸ä¼šå­˜åœ¨æ­»é”é—®é¢˜çš„ï¼Œä½†åœ¨5.7.18ç­‰ç‰ˆæœ¬ä¸­ï¼Œè¯¥æ“ä½œå´å¯èƒ½å¯¼è‡´æ­»é”ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æäº§ç”Ÿçš„åŸå› ã€‚</p>

<h2 id="åŸå› åˆ†æ">åŸå› åˆ†æ</h2>

<h3 id="æ•°æ®è¡¨å’Œä¾‹å­">æ•°æ®è¡¨å’Œä¾‹å­</h3>

<p>å‡å¦‚æ•°æ®è¡¨<code class="language-plaintext highlighter-rouge">Test</code>çš„ç»“æ„å¦‚ä¸‹ï¼š</p>

<table>
  <thead>
    <tr>
      <th>Id</th>
      <th>Uniq</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>1</td>
    </tr>
    <tr>
      <td>2</td>
      <td>2</td>
    </tr>
    <tr>
      <td>6</td>
      <td>6</td>
    </tr>
  </tbody>
</table>

<p>å…¶ä¸­<code class="language-plaintext highlighter-rouge">Id</code>ä¸ºä¸»é”®ï¼Œ<code class="language-plaintext highlighter-rouge">Uniq</code>ä¸ºå”¯ä¸€ç´¢å¼•ï¼Œæ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼š</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Transaction 1:
start transaction;
insert into Test values(3,3) on duplicate key update id=3,uniq=3;

Transaction 2:
start transaction;
insert into Test values(4,4) on duplicate key update id=4,uniq=4;

Transaction 3:
start transaction;
insert into Test values(5,5) on duplicate key update id=5,uniq=5;
</code></pre></div></div>

<h3 id="åŸå› åˆ†æ-1">åŸå› åˆ†æ</h3>

<p>ç†è®ºä¸Šè¿™ä¸‰æ¡è®°å½•çš„ä¸»é”®å€¼å’Œå”¯ä¸€ç´¢å¼•å€¼éƒ½ä¸ä¸€æ ·ï¼Œä»–ä»¬æ’å…¥çš„æ—¶å€™éƒ½ä¼šè·å–<code class="language-plaintext highlighter-rouge">(2,6)</code>åŒºé—´çš„<code class="language-plaintext highlighter-rouge">Insert Intention Lock</code>ï¼Œä½†ç”±äºå„è‡ªæ’å…¥çš„ä¸»é”®å€¼å’Œå”¯ä¸€ç´¢å¼•æ²¡æœ‰å†²çªï¼Œæ‰€ä»¥å®é™…æ˜¯å¯ä»¥æ­£å¸¸æ’å…¥çš„çš„ï¼Œä¸ä¼šå‘ç”Ÿæ€ç´¢ã€‚</p>

<p>é‚£ä¹ˆä¸ºä»€ä¹ˆMySQLçš„éƒ¨åˆ†ç‰ˆæœ¬è¿™ç§æƒ…å†µä¸‹ä¼šå‘ç”Ÿæ­»é”äº†ï¼Ÿ</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://bugs.mysql.com/bug.php?id=52020

This Bug#52020 (accidental re-introduction of Bug#7975 in MySQL 5.1) affects tables that do not contain a secondary index.

There is another bug that affects tables with secondary indexes:

Bug#50413 insert on duplicate key update sometimes writes binlog position incorrectly

Despite the title, Bug#50413 can occur even if MySQL replication or binlog is not used. That bug has was fixed in MySQL 5.7.4. 
The fix is that when we encounter a duplicate key in the clustered index or in any unique secondary index during an INSERT, 

we will acquire gap locks in the not-yet-checked secondary indexes as well. In this way, the INSERT will already have acquired some locks for the ON DUPLICATE KEY UPDATE part,

thus avoiding some potential deadlocks.

When there are multiple unique indexes, the execution of ON DUPLICATE KEY UPDATE can be ambiguous, which makes it tricky for statement-based replication.
</code></pre></div></div>

<p>æ³¨æ„ä¸Šé¢å™è¿°ä¸­çš„å…³é”®ä¸€æ¡ï¼š<code class="language-plaintext highlighter-rouge">Despite the title, Bug#50413 can occur even if MySQL replication or binlog is not used. That bug has was fixed in MySQL 5.7.4. The fix is that when we encounter a duplicate key in the clustered index or in any unique secondary index during an INSERT</code>ï¼Œå¼€å‘è€…ä¸ºäº†è§£å†³ä¸€ä¸ªBugï¼Œåœ¨<code class="language-plaintext highlighter-rouge">Insert</code>æ•°æ®æ—¶ï¼Œé™¤äº†ç»™ä¸»é”®åŠ <code class="language-plaintext highlighter-rouge">Insert Intention Lock</code>ï¼Œè¿˜ä¼šç»™å”¯ä¸€ç´¢å¼•åŠ <code class="language-plaintext highlighter-rouge">Gap Lock</code>ï¼Œä½†è¿™å°±å¸¦æ¥äº†è¿™ç¯‡æ–‡ç« æè¿°çš„é—®é¢˜ã€‚</p>

<p>å½“æˆ‘ä»¬ä¸Šæ–‡çš„ä¸‰ä¸ªäº‹åŠ¡æ’å…¥æ—¶ï¼Œä»–ä»¬é™¤äº†éƒ½æƒ³åœ¨<code class="language-plaintext highlighter-rouge">(2,6)</code>åŒºé—´åŠ <code class="language-plaintext highlighter-rouge">Insert Intention Lock</code>ä¹‹å¤–ï¼Œè¿˜æƒ³åœ¨<code class="language-plaintext highlighter-rouge">(2,6)</code>åŒºé—´ä¸ŠåŠ <code class="language-plaintext highlighter-rouge">Gap Lock</code>ï¼Œç”±äº<code class="language-plaintext highlighter-rouge">Insert Intention Lock</code>å’Œ<code class="language-plaintext highlighter-rouge">Gap Lock</code>å†²çªï¼Œè¿™æ‰å¯¼è‡´äº†æ­»é”ã€‚</p>
:ET